# Maintainer: Thomas Fanninger <thomas@fanninger.at>

pkgname=gogs-git-dev
_pkgname=gogs
pkgver=20140530
pkgrel=2
pkgdesc="Gogs(Go Git Service) is a Self Hosted Git Service in the Go Programming Language. This is the current git version from branch dev."
arch=('i686' 'x86_64' 'armv6h' 'armv7h')
url="http://gogits.org/"
license=('MIT')
depends=('git')
optdepends=('sqlite: SQLite support'
            'mariadb: MariaDB support'
            'postgresql: PostgreSQL support'
            'redis: Redis support'
            'memcached: MemCached support')
makedepends=('go>=1.2' 'git' 'patch')
conflicts=('gogs-bin' 'gogs' 'gogs-git')
options=('!strip' '!emptydirs')
backup=('srv/gogs/conf/app.ini')

install=gogs.install

source=('gogs.service'
        'app.ini.patch'
        'start.sh'
        "$_pkgname::git+http://github.com/gogits/gogs.git#branch=dev")

sha512sums=('SKIP'
            'SKIP'
            'SKIP'
            'SKIP')

_goroot="/usr/lib/go"

pkgver(){
  cd $startdir/$_pkgname/
  git log master..dev | grep commit | head -n 1 | cut -d " " -f 2
}

prepare() {
  export GOROOT=/usr/lib/go
  
  msg2 "Prepare GO build enviroment"
  rm -rf build
  mkdir -p build/go
  cd build/go

  for f in "$GOROOT/"*; do
    ln -s "$f"
  done

  rm pkg
  mkdir pkg
  cd pkg

  for f in "$GOROOT/pkg/"*; do
    ln -s "$f"
  done

  export GOROOT="$srcdir/build/go"
  export GOPATH="$srcdir/build"

  msg2 "Get dependency: github.com/gogits/cache"
  go get -d -fix -u github.com/gogits/cache
  msg2 "Get dependency: github.com/gogits/gfm"
  go get -d -fix -u github.com/gogits/gfm
  msg2 "Get dependency: github.com/gogits/git"
  go get -d -fix -u github.com/gogits/git
  msg2 "Get dependency: github.com/gogits/logs"
  go get -d -fix -u github.com/gogits/logs
  msg2 "Get dependency: github.com/gogits/oauth2"
  go get -d -fix -u github.com/gogits/oauth2
  msg2 "Get dependency: github.com/gogits/session"
  go get -d -fix -u github.com/gogits/session
  msg2 "Get dependency: github.com/Unknwon/cae"
  go get -d -fix -u github.com/Unknwon/cae
  msg2 "Get dependency: github.com/Unknwon/com"
  go get -d -fix -u github.com/Unknwon/com
  msg2 "Get dependency: github.com/Unknwon/goconfig"
  go get -d -fix -u github.com/Unknwon/goconfig
  msg2 "Get dependency: github.com/codegangsta/cli"
  go get -d -fix -u github.com/codegangsta/cli
  msg2 "Get dependency: github.com/codegangsta/inject"
  go get -d -fix -u github.com/codegangsta/inject
  msg2 "Get dependency: github.com/go-martini/martini"
  go get -d -fix -u github.com/go-martini/martini
  msg2 "Get dependency: github.com/go-sql-driver/mysql"
  go get -d -fix -u github.com/go-sql-driver/mysql
  msg2 "Get dependency: github.com/go-xorm/core"
  go get -d -fix -u github.com/go-xorm/core
  msg2 "Get dependency: github.com/go-xorm/xorm"
  go get -d -fix -u github.com/go-xorm/xorm
  msg2 "Get dependency: github.com/lib/pq"
  go get -d -fix -u github.com/lib/pq
  msg2 "Get dependency: github.com/mattn/go-sqlite3"
  go get -d -fix -u github.com/mattn/go-sqlite3
  msg2 "Get dependency: github.com/nfnt/resize"
  go get -d -fix -u github.com/nfnt/resize
  msg2 "Get dependency: github.com/qiniu/log"
  go get -d -fix -u github.com/qiniu/log
  msg2 "Get dependency: github.com/robfig/cron"
  go get -d -fix -u github.com/robfig/cron
  msg2 "Get dependency: github.com/juju2013/goldap"
  go get -d -fix -u github.com/juju2013/goldap
  msg2 "Get dependency: github.com/johnweldon/asn1-ber"
  go get -d -fix -u github.com/johnweldon/asn1-ber
  
  mkdir -p "$GOPATH/src/github.com/gogits"
  mv "$srcdir/$_pkgname" $GOPATH/src/github.com/gogits/gogs

  # Execute patch
  msg2 "Execute patches"
  patch -Np1 -i "$srcdir/app.ini.patch" "$GOPATH/src/github.com/gogits/gogs/conf/app.ini"
}

build() {
  cd $GOPATH/src/github.com/gogits/gogs

 msg2 "Build GO program"
  go fix
  go build -tags sqlite
}

package() {
  mkdir -p "$pkgdir/usr/share/$_pkgname/"
  cp "$startdir/start.sh" "$pkgdir/usr/share/$_pkgname/"
  chmod +x "$pkgdir/usr/share/$_pkgname/start.sh"
  cp "$srcdir/build/src/github.com/gogits/gogs/gogs" "$pkgdir/usr/share/$_pkgname/"
  chmod +x "$pkgdir/usr/share/$_pkgname/gogs"
  cp -r "$srcdir/build/src/github.com/gogits/gogs/conf" "$pkgdir/usr/share/$_pkgname"
	mkdir -p "$pkgdir/usr/share/themes/goges/default/"
  cp -r "$srcdir/build/src/github.com/gogits/gogs/public" "$pkgdir/usr/share/themes/goges/default"
  cp -r "$srcdir/build/src/github.com/gogits/gogs/templates" "$pkgdir/usr/share/themes/goges/default"
 
  mkdir -p "$pkgdir/srv/$_pkgname/conf"
  cp "$pkgdir/usr/share/$_pkgname/conf/app.ini" "$pkgdir/srv/$_pkgname/conf/app.ini"

  mkdir -p "$pkgdir/etc/systemd/system/"
  cp -r "$startdir/gogs.service" "$pkgdir/etc/systemd/system/"

  mkdir -p "$pkgdir/usr/share/licenses/$_pkgname"
  cp "$srcdir/build/src/github.com/gogits/gogs/LICENSE" "$pkgdir/usr/share/licenses/$_pkgname"
}
