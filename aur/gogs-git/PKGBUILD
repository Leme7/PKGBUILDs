# Maintainer: Thomas Fanninger <thomas@fanninger.at>

pkgname=gogs-git
_pkgname=gogs
pkgver=20140516
pkgrel=2
pkgdesc="Gogs(Go Git Service) is a Self Hosted Git Service in the Go Programming Language. This is the current git version from branch master."
arch=('i686' 'x86_64' 'armv6h' 'armv7h')
url="http://gogits.org/"
license=('MIT')
depends=('git')
optdepends=('sqlite: SQLite support'
            'mariadb: MariaDB support'
            'postgresql: PostgreSQL support'
            'redis'
            'memcache')
makedepends=('go>=1.2' 'git')
conflicts=('gogs-bin' 'gogs' 'gogs-git')
options=('!strip' '!emptydirs')

install=gogs.install

source=('gogs.service'
				'patch.diff'
				'git_gogits_gogs::git+https://github.com/gogits/gogs.git'
        'git_gogits_cache::git+https://github.com/gogits/cache.git'
        'git_gogits_gfm::git+https://github.com/gogits/gfm.git'
        'git_gogits_git::git+https://github.com/gogits/git.git'
        'git_gogits_logs::git+https://github.com/gogits/logs.git'
        'git_gogits_oauth2::git+https://github.com/gogits/oauth2.git'
        'git_gogits_session::git+https://github.com/gogits/session.git'
        'git_Unknwon_cae::git+https://github.com/Unknwon/cae.git'
        'git_Unknwon_com::git+https://github.com/Unknwon/com.git'
        'git_Unknwon_goconfig::git+https://github.com/Unknwon/goconfig.git'
        'git_codegangsta_cli::git+https://github.com/codegangsta/cli.git'
				'git_codegangsta_inject::git+https://github.com/codegangsta/inject.git'
        'git_go-martini_martini::git+https://github.com/go-martini/martini.git'
        'git_go-sql-driver_mysql::git+https://github.com/go-sql-driver/mysql.git'
        'git_go-xorm_core::git+https://github.com/go-xorm/core.git'
        'git_go-xorm_xorm::git+https://github.com/go-xorm/xorm.git'
        'git_lib_pq::git+https://github.com/lib/pq.git'
        'git_mattn_go-sqlite3::git+https://github.com/mattn/go-sqlite3.git'
        'git_nfnt_resize::git+https://github.com/nfnt/resize.git'
        'git_qiniu_log::git+https://github.com/qiniu/log.git'
        'git_robfig_cron::git+https://github.com/robfig/cron.git'
        'git_juju2013_goldap::git+https://github.com/juju2013/goldap.git'
        'git_johnweldon_asn1-ber::git+https://github.com/johnweldon/asn1-ber.git')

sha512sums=('daf96cda9b116ee54eecabb23cd70521528c1eff26f43f3ee985c9d651ad0e5206d251fac182f106ea49b9be78bcab0f8ed3b3489b464c40add4160bab4902e7'
            '8d53503c335ac35a4a6e4c5cf2118d33926997c1052f81088ced114993d78b50fcf6055c14ccd0d03c88dfb7b43a58481dfe8aa757ebd7d3b2a5fe3b7d158a61'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP')

_goroot="/usr/lib/go"

pkgver(){
	cd $startdir/git_gogits_gogs/
	git log --grep=commit -1 | grep "commit " | cut -d " " -f 2
}

prepare() {
  export GOROOT=/usr/lib/go

  rm -rf build
  mkdir -p build/go
  cd build/go

  for f in "$GOROOT/"*; do
    ln -s "$f"
  done

  rm pkg
  mkdir pkg
  cd pkg

  for f in "$GOROOT/pkg/"*; do
    ln -s "$f"
  done

  export GOROOT="$srcdir/build/go"
  export GOPATH="$srcdir/build"
  
  #Depence
	mkdir -p "$GOPATH/src/github.com/gogits"
	mv "$srcdir/git_gogits_gogs" $GOPATH/src/github.com/gogits/gogs
	mv "$srcdir/git_gogits_cache" $GOPATH/src/github.com/gogits/cache
	mv "$srcdir/git_gogits_gfm" $GOPATH/src/github.com/gogits/gfm
	mv "$srcdir/git_gogits_git" $GOPATH/src/github.com/gogits/git
	mv "$srcdir/git_gogits_logs" $GOPATH/src/github.com/gogits/logs
	mv "$srcdir/git_gogits_oauth2" $GOPATH/src/github.com/gogits/oauth2
	mv "$srcdir/git_gogits_session" $GOPATH/src/github.com/gogits/session
	mkdir -p "$GOPATH/src/github.com/Unknwon"
	mv "$srcdir/git_Unknwon_cae" $GOPATH/src/github.com/Unknwon/cae
	mv "$srcdir/git_Unknwon_com" $GOPATH/src/github.com/Unknwon/com
	mv "$srcdir/git_Unknwon_goconfig" $GOPATH/src/github.com/Unknwon/goconfig
	mkdir -p "$GOPATH/src/github.com/codegangsta"
	mv "$srcdir/git_codegangsta_cli" $GOPATH/src/github.com/codegangsta/cli
	mv "$srcdir/git_codegangsta_inject" $GOPATH/src/github.com/codegangsta/inject
	mkdir -p "$GOPATH/src/github.com/go-martini"
	mv "$srcdir/git_go-martini_martini" $GOPATH/src/github.com/go-martini/martini
	mkdir -p "$GOPATH/src/github.com/go-sql-driver"
	mv "$srcdir/git_go-sql-driver_mysql" $GOPATH/src/github.com/go-sql-driver/mysql
	mkdir -p "$GOPATH/src/github.com/go-xorm"
	mv "$srcdir/git_go-xorm_core" $GOPATH/src/github.com/go-xorm/core
	mv "$srcdir/git_go-xorm_xorm" $GOPATH/src/github.com/go-xorm/xorm
	mkdir -p "$GOPATH/src/github.com/lib"
	mv "$srcdir/git_lib_pq" $GOPATH/src/github.com/lib/pq
  mkdir -p "$GOPATH/src/github.com/mattn"
	mv "$srcdir/git_mattn_go-sqlite3" $GOPATH/src/github.com/mattn/go-sqlite3
	mkdir -p "$GOPATH/src/github.com/nfnt"
	mv "$srcdir/git_nfnt_resize" $GOPATH/src/github.com/nfnt/resize
	mkdir -p "$GOPATH/src/github.com/qiniu"
	mv "$srcdir/git_qiniu_log" $GOPATH/src/github.com/qiniu/log
	mkdir -p "$GOPATH/src/github.com/robfig"
	mv "$srcdir/git_robfig_cron" $GOPATH/src/github.com/robfig/cron
	mkdir -p "$GOPATH/src/github.com/juju2013"
	mv "$srcdir/git_juju2013_goldap" $GOPATH/src/github.com/juju2013/goldap
	mkdir -p "$GOPATH/src/github.com/johnweldon"
	mv "$srcdir/git_johnweldon_asn1-ber" $GOPATH/src/github.com/johnweldon/asn1-ber
}

build() {
  # Fix and compile code
  cd $GOPATH/src/github.com/gogits/gogs

	# Execute patch
  patch -Np1 -i $srcdir/patch.diff

  go fix
  go build -tags sqlite
}

package() {
  mkdir -p "$pkgdir/home/$_pkgname/"
  cp "$srcdir/build/src/github.com/gogits/gogs/gogs" "$pkgdir/home/$_pkgname/"
  cp -r "$srcdir/build/src/github.com/gogits/gogs/conf" "$pkgdir/home/$_pkgname"
  cp -r "$srcdir/build/src/github.com/gogits/gogs/public" "$pkgdir/home/$_pkgname"
  cp -r "$srcdir/build/src/github.com/gogits/gogs/templates" "$pkgdir/home/$_pkgname"
  
  mkdir -p "$pkgdir/etc/systemd/system/"
  cp -r "$startdir/gogs.service" "$pkgdir/etc/systemd/system/"

  mkdir -p "$pkgdir/usr/share/licenses/$_pkgname"
  cp "$srcdir/build/src/github.com/gogits/gogs/LICENSE" "$pkgdir/usr/share/licenses/$_pkgname"
}
